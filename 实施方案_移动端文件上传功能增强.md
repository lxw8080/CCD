# 实施方案 - 移动端文件上传功能增强

**日期**: 2025-10-19  
**版本**: 1.0

---

## 📋 需求分析

### 目标功能

为移动端客户详情页面添加以下三个增强特性：

1. **支持上传相册图片**
   - 允许用户从手机相册中选择已有的图片
   - 支持多选图片（最多 10 张）
   - 保持现有的拍照功能

2. **支持直接录制视频**
   - 允许用户直接使用手机摄像头录制视频
   - 支持从相册选择已有视频
   - 视频大小限制：50MB
   - 视频格式：mp4, mov, avi

3. **支持上传手机内部文件**
   - 允许用户从手机文件管理器选择文件
   - 支持的文件类型：
     - 图片：jpg, jpeg, png, gif (5MB)
     - 视频：mp4, mov, avi (50MB)
     - PDF：pdf (10MB)
     - 文档：doc, docx, xls, xlsx (10MB)

---

## 🔧 技术方案

### 1. Vant Uploader 配置

**当前配置**:
```javascript
<van-uploader
  v-model="fileList"
  :max-count="10"
  multiple
  :after-read="afterRead"
  :before-delete="beforeDelete"
  accept="image/*"
  capture="camera"
/>
```

**问题**:
- `accept="image/*"` 只允许图片
- `capture="camera"` 只允许拍照
- 不支持从相册选择或录制视频

**解决方案**:
- 根据选择的资料类型动态设置 `accept` 属性
- 根据文件类型设置 `capture` 属性
- 支持多种输入源

### 2. 动态 Accept 属性

根据资料类型的 `allowed_file_types` 字段，动态生成 accept 属性：

```javascript
const uploaderAccept = computed(() => {
  const docType = currentDocumentType.value
  if (!docType || !docType.allowed_file_types || docType.allowed_file_types.length === 0) {
    return 'image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx'
  }

  const accepts = []
  if (docType.allowed_file_types.includes('image')) {
    accepts.push('image/*')
  }
  if (docType.allowed_file_types.includes('video')) {
    accepts.push('video/*')
  }
  if (docType.allowed_file_types.includes('pdf')) {
    accepts.push('.pdf')
  }
  if (docType.allowed_file_types.includes('document')) {
    accepts.push('.doc', '.docx', '.txt', '.rtf')
  }
  if (docType.allowed_file_types.includes('spreadsheet')) {
    accepts.push('.xls', '.xlsx', '.csv')
  }

  return accepts.join(',')
})
```

### 3. 动态 Capture 属性

根据文件类型设置 capture 属性：

```javascript
const uploaderCapture = computed(() => {
  const docType = currentDocumentType.value
  if (!docType || !docType.allowed_file_types) {
    return 'environment' // 默认使用后置摄像头
  }

  // 如果只允许视频，使用视频录制
  if (docType.allowed_file_types.length === 1 && docType.allowed_file_types[0] === 'video') {
    return 'camcorder' // 视频录制
  }

  // 如果允许图片，使用相机拍照
  if (docType.allowed_file_types.includes('image')) {
    return 'environment' // 后置摄像头
  }

  // 其他情况不使用 capture
  return undefined
})
```

### 4. 文件验证增强

在 `afterRead` 函数中添加文件验证：

```javascript
const afterRead = (file) => {
  // 验证文件类型
  const docType = currentDocumentType.value
  if (!docType) {
    showToast('请先选择资料类型')
    return
  }

  // 检查文件类型是否被允许
  const fileType = getFileType(file.file.name)
  if (!docType.allowed_file_types.includes(fileType)) {
    showToast(`不支持上传 ${getFileTypeName(fileType)} 文件`)
    return
  }

  // 检查文件大小
  const sizeLimit = getFileSizeLimit(fileType)
  if (file.file.size > sizeLimit) {
    showToast(`文件大小超过限制 (最大 ${formatFileSizeLimit(fileType)})`)
    return
  }
}
```

### 5. 上传前验证

在 `handleUpload` 函数中添加更详细的验证：

```javascript
const handleUpload = async () => {
  // ... 现有验证 ...

  // 验证每个文件
  for (const item of fileList.value) {
    const fileType = getFileType(item.file.name)
    const sizeLimit = getFileSizeLimit(fileType)
    
    if (item.file.size > sizeLimit) {
      showToast(`${item.file.name} 文件大小超过限制`)
      return
    }
  }

  // ... 继续上传 ...
}
```

---

## 📝 修改清单

### 文件修改

1. **frontend/src/views/mobile/CustomerDetail.vue**
   - 添加 `uploaderAccept` 计算属性
   - 添加 `uploaderCapture` 计算属性
   - 更新 `van-uploader` 的 `accept` 和 `capture` 属性
   - 增强 `afterRead` 函数的文件验证
   - 增强 `handleUpload` 函数的文件验证

2. **frontend/src/utils/fileType.js** (可能需要)
   - 检查是否需要添加新的工具函数

---

## 🎯 预期效果

### 用户体验

1. **选择资料类型后**:
   - 上传器自动显示该类型允许的文件选项
   - 用户可以选择拍照、录制视频或从相册/文件管理器选择

2. **选择文件时**:
   - 系统自动验证文件类型和大小
   - 如果不符合要求，显示清晰的错误提示

3. **上传前**:
   - 再次验证所有文件
   - 显示文件信息和上传进度

### 功能验证

- ✅ 支持从相册选择图片
- ✅ 支持拍照上传
- ✅ 支持录制视频
- ✅ 支持从相册选择视频
- ✅ 支持从文件管理器选择各种文件
- ✅ 文件类型验证正常
- ✅ 文件大小验证正常
- ✅ 错误提示清晰

---

## 🚀 实施步骤

1. **修改 CustomerDetail.vue**
   - 添加计算属性
   - 更新模板
   - 增强验证逻辑

2. **测试功能**
   - 测试各种文件上传场景
   - 验证错误提示

3. **生成文档**
   - 功能测试报告
   - 用户操作说明

---

**实施方案完成** ✅

