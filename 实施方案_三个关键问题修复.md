# 实施方案 - 三个关键问题修复

**日期**: 2025-10-18  
**版本**: 1.0

---

## 问题分析

### 问题 1: 移动端 PDF.js Worker 加载错误

**错误信息**:
```
GET https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.296/pdf.worker.min.js?import net::ERR_ABORTED 404
```

**根本原因**:
- PDF.js 版本 5.4.296 的 CDN 路径可能不存在或格式不正确
- Vite 在处理动态导入时可能添加了 `?import` 参数
- 需要使用本地 worker 文件而不是 CDN

**解决方案**:
1. 从 `node_modules/pdfjs-dist/build/` 复制 `pdf.worker.min.js` 到 `public/` 目录
2. 修改 worker 配置使用本地路径
3. 确保 PC 端和移动端配置一致

### 问题 2: PC 端 PDF 预览功能

**需要验证**:
- 使用真实 PDF 文件 `C:\Users\16094\Desktop\01.pdf` 进行测试
- 检查 PDF 加载和渲染是否正常
- 验证页码导航功能

**可能的问题**:
- Worker 加载失败导致 PDF 无法渲染
- PDF 文件 URL 不可访问
- Canvas 渲染出错

### 问题 3: 资料类型文件限制未生效

**需要实现**:
1. **后端验证** - 强制验证文件类型和数量
2. **前端验证** - 提升用户体验

---

## 实施步骤

### 第一步：修复 PDF.js Worker 加载问题

#### 1.1 复制 Worker 文件到 Public 目录

```bash
# 从 node_modules 复制 worker 文件
cp node_modules/pdfjs-dist/build/pdf.worker.min.js public/
```

#### 1.2 修改 PreviewDialog.vue

```javascript
// 使用本地 worker 文件
pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.js'
```

#### 1.3 修改 MobilePreviewDialog.vue

```javascript
// 使用本地 worker 文件
pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.js'
```

### 第二步：测试 PC 端 PDF 预览

1. 上传真实 PDF 文件 `01.pdf`
2. 在 PC 端客户详情页面测试预览
3. 验证页码导航功能
4. 检查浏览器控制台是否有错误

### 第三步：实现后端文件限制验证

#### 3.1 修改 views.py

在文件上传视图中添加验证逻辑：

```python
def validate_file_upload(document_type, file_type, customer_id):
    """验证文件上传是否符合限制"""
    
    # 1. 检查文件类型限制
    if document_type.allowed_file_types:
        if file_type not in document_type.allowed_file_types:
            raise ValidationError(f"不支持的文件类型: {file_type}")
    
    # 2. 检查文件数量限制
    if document_type.max_file_count > 0:
        count = Document.objects.filter(
            customer_id=customer_id,
            document_type=document_type
        ).count()
        if count >= document_type.max_file_count:
            raise ValidationError(
                f"该资料类型最多只能上传 {document_type.max_file_count} 个文件"
            )
```

### 第四步：实现前端文件限制验证

#### 4.1 PC 端 (CustomerDetail.vue)

```javascript
// 当选择资料类型时
const handleDocumentTypeChange = async () => {
  if (uploadForm.documentType) {
    // 获取资料类型详情
    const docType = documentTypes.value.find(
      dt => dt.id === uploadForm.documentType
    )
    
    // 更新 accept 属性
    if (docType?.allowed_file_types?.length > 0) {
      // 根据允许的类型生成 accept 字符串
    }
    
    // 检查文件数量限制
    const uploadedCount = documents.value.filter(
      doc => doc.document_type === uploadForm.documentType
    ).length
    
    canUpload.value = uploadedCount < (docType?.max_file_count || 0)
  }
}
```

#### 4.2 移动端 (mobile/CustomerDetail.vue)

- 实现与 PC 端相同的逻辑
- 使用 Vant 组件的相应属性

---

## 测试计划

### 测试 1: PDF.js Worker 加载

- [ ] 移动端 PDF 预览不报错
- [ ] PC 端 PDF 预览不报错
- [ ] 浏览器控制台无错误

### 测试 2: PDF 预览功能

- [ ] 上传真实 PDF 文件
- [ ] PC 端预览正常显示
- [ ] 页码导航功能正常
- [ ] 下载功能正常

### 测试 3: 文件限制验证

- [ ] 后端验证文件类型
- [ ] 后端验证文件数量
- [ ] 前端禁用上传按钮
- [ ] 前端显示提示信息

---

## 预期结果

✅ PDF.js Worker 正常加载  
✅ PC 端和移动端 PDF 预览正常工作  
✅ 文件类型限制生效  
✅ 文件数量限制生效  
✅ 用户体验改进

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Worker 文件丢失 | 低 | 高 | 检查 public 目录 |
| 路径配置错误 | 中 | 高 | 测试验证 |
| 后端验证冲突 | 低 | 中 | 充分测试 |

---

**实施方案完成** ✅

