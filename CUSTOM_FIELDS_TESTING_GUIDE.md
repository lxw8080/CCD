# 动态自定义字段功能测试指南

## 功能概述

本系统实现了一个完整的动态自定义字段系统，允许管理员通过后台配置客户信息表单的自定义字段，无需修改代码或数据库结构。

## 已实现的功能

### 1. 后端功能
- ✅ 自定义字段模型（CustomField）支持8种字段类型
- ✅ 自定义字段值存储（CustomFieldValue）
- ✅ Django Admin 管理界面
- ✅ RESTful API 接口
- ✅ 字段验证规则（必填、长度、范围、正则表达式）
- ✅ 字段排序和默认值

### 2. 前端功能
- ✅ PC端动态表单渲染（Element Plus）
- ✅ 移动端动态表单渲染（Vant）
- ✅ 自动获取和显示自定义字段
- ✅ 字段验证规则动态生成
- ✅ 支持的字段类型：
  - 文本输入（text）
  - 数字输入（number）
  - 日期选择（date）
  - 下拉菜单（select）
  - 多行文本（textarea）
  - 邮箱（email）
  - 手机号（phone）
  - 网址（url）

## 测试环境

### 服务器状态
- **后端服务器**: http://127.0.0.1:8000/ ✅ 运行中
- **前端服务器**: http://localhost:3000/ ✅ 运行中
- **Django Admin**: http://127.0.0.1:8000/admin/

### 测试账号
- **用户名**: admin
- **密码**: admin123

### 已创建的测试数据
系统已自动创建了9个示例自定义字段：

1. **产品** (下拉菜单) - 必填
   - 选项：个人贷款、企业贷款、信用卡、房屋贷款、汽车贷款

2. **贷款金额** (数字) - 必填
   - 范围：1-1000万元

3. **申请日期** (日期) - 必填

4. **工作单位** (文本) - 可选
   - 长度：2-100字符

5. **月收入** (数字) - 可选
   - 范围：0-1000000元

6. **联系邮箱** (邮箱) - 可选

7. **备用联系人** (文本) - 可选

8. **备用联系电话** (手机号) - 可选

9. **特殊说明** (多行文本) - 可选

## 测试步骤

### 第一步：访问 Django Admin 管理后台

1. 打开浏览器访问: http://127.0.0.1:8000/admin/
2. 使用测试账号登录（admin / admin123）
3. 在左侧菜单找到 "Customers" 部分
4. 点击 "Custom fields" 查看已创建的自定义字段

**验证点**:
- ✅ 能看到9个自定义字段
- ✅ 每个字段显示名称、类型、是否必填、排序等信息
- ✅ 可以点击编辑查看详细配置

### 第二步：测试自定义字段管理

1. 在 Django Admin 中点击 "Add Custom field" 创建新字段
2. 尝试创建一个新的自定义字段，例如：
   - 名称：客户来源
   - 字段类型：下拉菜单
   - 是否必填：是
   - 排序：10
   - 选项：["网络推广", "朋友介绍", "线下活动", "其他"]
3. 保存字段

**验证点**:
- ✅ 字段创建成功
- ✅ 字段出现在列表中
- ✅ 可以编辑和删除字段

### 第三步：测试 PC 端客户表单

1. 打开浏览器访问: http://localhost:3000/
2. 使用测试账号登录（admin / admin123）
3. 导航到客户管理页面
4. 点击"新建客户"按钮

**验证点**:
- ✅ 表单中显示所有自定义字段
- ✅ 必填字段标记为红色星号
- ✅ 字段按照 sort_order 排序显示
- ✅ 不同字段类型渲染正确的输入组件：
  - 下拉菜单显示为 el-select
  - 数字显示为 el-input-number
  - 日期显示为 el-date-picker
  - 文本显示为 el-input
  - 多行文本显示为 textarea

### 第四步：测试字段验证

1. 在新建客户表单中，尝试以下操作：
   - 不填写必填字段，点击保存 → 应显示验证错误
   - 在"贷款金额"中输入超出范围的值（如1001） → 应显示错误
   - 在"联系邮箱"中输入无效邮箱 → 应显示格式错误
   - 在"备用联系电话"中输入无效手机号 → 应显示格式错误

**验证点**:
- ✅ 必填验证生效
- ✅ 数字范围验证生效
- ✅ 邮箱格式验证生效
- ✅ 手机号格式验证生效

### 第五步：测试创建客户

1. 填写完整的客户信息，包括所有必填字段
2. 填写一些自定义字段的值
3. 点击"保存"按钮

**验证点**:
- ✅ 客户创建成功
- ✅ 显示成功提示
- ✅ 跳转到客户列表页面

### 第六步：测试编辑客户

1. 在客户列表中点击刚创建的客户
2. 进入编辑页面

**验证点**:
- ✅ 所有基本信息正确显示
- ✅ 所有自定义字段的值正确显示
- ✅ 可以修改自定义字段的值
- ✅ 保存后更新成功

### 第七步：测试移动端表单

1. 在浏览器中打开开发者工具（F12）
2. 切换到移动设备模拟模式
3. 刷新页面或访问 http://localhost:3000/
4. 导航到客户管理，点击新建客户

**验证点**:
- ✅ 移动端表单正确显示所有自定义字段
- ✅ 使用 Vant 组件渲染（van-field）
- ✅ 日期选择器使用 van-date-picker
- ✅ 下拉菜单使用 van-picker
- ✅ 所有验证规则正常工作
- ✅ 可以成功创建和编辑客户

### 第八步：测试字段动态更新

1. 回到 Django Admin
2. 修改某个自定义字段的配置（如修改名称或选项）
3. 或者创建一个新的自定义字段
4. 回到前端客户表单页面，刷新页面

**验证点**:
- ✅ 字段修改立即生效
- ✅ 新字段立即出现在表单中
- ✅ 无需重新部署代码

### 第九步：测试字段删除行为

1. 在 Django Admin 中，将某个自定义字段设置为"不活跃"（is_active = False）
2. 刷新前端表单页面

**验证点**:
- ✅ 不活跃的字段不再显示在表单中
- ✅ 已有客户的历史数据仍然保留（在数据库中）

## API 端点测试

可以使用以下 curl 命令测试 API（需要先获取认证 token）：

```bash
# 获取自定义字段列表
curl -H "Authorization: Bearer YOUR_TOKEN" http://127.0.0.1:8000/api/customers/custom-fields/

# 获取单个自定义字段
curl -H "Authorization: Bearer YOUR_TOKEN" http://127.0.0.1:8000/api/customers/custom-fields/1/

# 创建客户（包含自定义字段）
curl -X POST -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三",
    "id_card": "110101199001011234",
    "phone": "13800138000",
    "address": "北京市朝阳区",
    "status": "pending",
    "custom_fields": {
      "1": "个人贷款",
      "2": "50",
      "3": "2025-10-21"
    }
  }' \
  http://127.0.0.1:8000/api/customers/
```

## 数据库结构

### CustomField 表
存储自定义字段的定义：
- id: 主键
- name: 字段名称
- field_type: 字段类型
- is_required: 是否必填
- is_active: 是否启用
- sort_order: 排序
- placeholder: 占位符
- help_text: 帮助文本
- default_value: 默认值
- options: 选项（JSON）
- min_length, max_length: 文本长度限制
- min_value, max_value: 数值范围限制
- regex_pattern: 正则表达式验证

### CustomFieldValue 表
存储客户的自定义字段值：
- id: 主键
- customer_id: 客户ID（外键）
- custom_field_id: 自定义字段ID（外键）
- value: 字段值（文本存储）
- unique_together: (customer, custom_field) 确保每个客户每个字段只有一个值

## 技术实现要点

### 后端
1. 使用 JSONField 存储下拉菜单选项和验证规则
2. 使用 unique_together 约束确保数据一致性
3. 序列化器自动处理自定义字段的读写
4. 支持字段的软删除（is_active）

### 前端
1. 组件挂载时自动获取自定义字段配置
2. 根据字段类型动态渲染不同的输入组件
3. 根据字段配置动态生成验证规则
4. 编辑时自动填充已有的自定义字段值
5. 提交时将自定义字段值转换为正确的格式

## 常见问题排查

### 问题1：自定义字段不显示
- 检查字段的 is_active 是否为 True
- 检查前端控制台是否有 API 错误
- 检查后端日志是否有错误

### 问题2：验证规则不生效
- 检查字段配置中的验证规则是否正确设置
- 检查前端 getFieldRules 函数是否正确生成规则

### 问题3：保存失败
- 检查必填字段是否都已填写
- 检查字段值是否符合验证规则
- 检查后端日志查看具体错误信息

## 下一步优化建议

1. **字段分组**: 支持将自定义字段分组显示
2. **条件显示**: 支持根据其他字段的值显示/隐藏某些字段
3. **字段依赖**: 支持字段之间的依赖关系
4. **批量导入**: 支持批量导入自定义字段配置
5. **字段模板**: 支持保存和复用字段配置模板
6. **历史记录**: 记录字段值的修改历史
7. **权限控制**: 不同角色可见不同的自定义字段

## 总结

本系统成功实现了一个完整的动态自定义字段功能，具有以下优势：

✅ **灵活性**: 管理员可以随时添加、修改、删除字段，无需修改代码
✅ **可扩展性**: 支持8种常用字段类型，易于扩展新类型
✅ **用户友好**: PC端和移动端都有良好的用户体验
✅ **数据完整性**: 使用数据库约束确保数据一致性
✅ **验证完善**: 支持多种验证规则，确保数据质量
✅ **即时生效**: 后台配置修改后立即在前端生效

系统已准备好进行全面测试！

