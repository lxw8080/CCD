# 诊断报告 - 移动端文件预览问题详细分析

**日期**: 2025-10-19  
**版本**: 2.0

---

## 📋 问题概述

移动端文件预览功能出现问题，图片、PDF、视频均无法正确预览。

---

## 🔍 已完成的诊断

### 1. 后端 API 检查 ✅

**测试结果**:
- ✅ 后端返回的 `file_type` 字段格式正确
- ✅ 返回的值为: 'image', 'video', 'pdf'
- ✅ API 返回的是分页数据: `{count, next, previous, results: [...]}`

**示例数据**:
```json
{
  "id": 31,
  "file_name": "VID_20251019_011234.mp4",
  "file_type": "video",
  "file_url": "http://127.0.0.1:8000/media/documents/5/5_12_20251018171240.mp4"
}
```

### 2. 前端代码检查 ✅

**fetchDocuments 函数** (第 344-352 行):
```javascript
const fetchDocuments = async () => {
  documentsLoading.value = true
  try {
    const response = await getDocuments({ customer_id: route.params.id })
    documents.value = response.results || []  // ✅ 正确提取 results
  } catch (error) {
    showToast('获取资料列表失败')
  } finally {
    documentsLoading.value = false
  }
}
```

**handlePreview 函数** (第 487-506 行):
```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  
  // 如果后端没有返回 file_type，从文件名中获取
  if (doc.file_type) {
    previewFileType.value = doc.file_type  // ✅ 正确使用 doc.file_type
  } else {
    previewFileType.value = getFileType(doc.file_name) || 'image'
  }
  
  previewVisible.value = true
  
  console.log('预览文件:', {
    url: doc.file_url,
    name: doc.file_name,
    type: previewFileType.value,
    rawType: doc.file_type
  })
}
```

**MobilePreviewDialog 组件** - showPreview 函数 (第 120-142 行):
```javascript
const showPreview = () => {
  console.log('显示预览:', {
    fileUrl: props.fileUrl,
    fileName: props.fileName,
    fileType: props.fileType
  })
  
  if (isImage(props.fileType)) {
    console.log('显示图片预览')
    previewImages.value = [props.fileUrl]
    previewIndex.value = 0
    imagePreviewVisible.value = true
  } else if (isVideo(props.fileType)) {
    console.log('显示视频预览')
    videoUrl.value = props.fileUrl
    videoPreviewVisible.value = true
  } else if (isPdf(props.fileType)) {
    console.log('显示 PDF 预览')
    loadPdf()
  } else {
    console.log('不支持预览，显示下载提示，文件类型:', props.fileType)
    downloadPromptVisible.value = true
  }
}
```

---

## 🤔 可能的问题

### 问题 1: Props 传递问题

**可能原因**: `previewFileType` 可能没有正确传递给 `MobilePreviewDialog` 组件

**检查位置**: `CustomerDetail.vue` 中 `MobilePreviewDialog` 组件的使用

**需要检查**:
```vue
<MobilePreviewDialog
  v-model="previewVisible"
  :file-url="previewUrl"
  :file-name="previewFileName"
  :file-type="previewFileType"  <!-- 检查这里是否正确 -->
/>
```

### 问题 2: 文件 URL 访问问题

**可能原因**: 文件 URL 可能存在 CORS 问题或文件不存在

**需要检查**:
- 文件 URL 是否可以直接访问
- 是否存在 CORS 限制
- 文件是否真实存在

### 问题 3: PDF.js Worker 路径问题

**可能原因**: PDF.js worker 文件路径可能不正确

**需要检查**:
- `/pdf.worker.min.mjs` 文件是否存在于 `public` 目录
- Worker 文件是否可以正常加载

### 问题 4: 视频播放问题

**可能原因**: 视频格式可能不被浏览器支持

**需要检查**:
- 视频编码格式
- 浏览器是否支持该格式

---

## 🔧 下一步诊断步骤

### 步骤 1: 检查 MobilePreviewDialog 组件的使用

查看 `CustomerDetail.vue` 中 `MobilePreviewDialog` 组件的完整定义。

### 步骤 2: 在浏览器中实际测试

1. 打开移动端页面: `http://127.0.0.1:3001/customers/5`
2. 打开浏览器开发者工具
3. 切换到 Console 标签
4. 点击预览文件
5. 查看控制台输出

**预期输出**:
```
预览文件: { url: "...", name: "...", type: "video", rawType: "video" }
显示预览: { fileUrl: "...", fileName: "...", fileType: "video" }
显示视频预览
```

### 步骤 3: 检查文件 URL

在浏览器中直接访问文件 URL，确认文件是否可以访问。

### 步骤 4: 检查 PDF.js Worker

在浏览器中访问 `http://127.0.0.1:3001/pdf.worker.min.mjs`，确认文件是否存在。

---

## 📝 调试清单

- [ ] 检查 MobilePreviewDialog 组件的 props 传递
- [ ] 在浏览器控制台查看调试日志
- [ ] 检查文件 URL 是否可以访问
- [ ] 检查 PDF.js worker 文件是否存在
- [ ] 检查视频格式是否被浏览器支持
- [ ] 检查是否有 JavaScript 错误

---

## 💡 建议的修复方案

### 方案 1: 确保 Props 正确传递

检查并确认 `MobilePreviewDialog` 组件的 props 定义和使用是否一致。

### 方案 2: 添加更多调试日志

在关键位置添加更多 `console.log`，帮助定位问题。

### 方案 3: 检查文件访问权限

确保文件 URL 可以被浏览器访问，没有 CORS 限制。

### 方案 4: 验证 PDF.js 配置

确保 PDF.js worker 文件路径正确，文件存在。

---

**诊断报告待完成** ⏳

需要在浏览器中实际测试才能确定具体问题。

