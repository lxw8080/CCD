# å¿«é€Ÿå‚è€ƒ - ä¸‰ä¸ªå…³é”®é—®é¢˜ä¿®å¤

**æ—¥æœŸ**: 2025-10-18  
**ç‰ˆæœ¬**: 1.0

---

## ğŸ”§ ä¿®å¤å†…å®¹é€Ÿè§ˆ

### é—®é¢˜ 1: PDF.js Worker åŠ è½½é”™è¯¯

**ç—‡çŠ¶**: ç§»åŠ¨ç«¯ PDF é¢„è§ˆæŠ¥é”™ 404

**ä¿®å¤**:
1. åˆ›å»º `frontend/public` ç›®å½•
2. å¤åˆ¶ `pdf.worker.min.mjs` åˆ° public ç›®å½•
3. æ›´æ–° worker é…ç½®ä¸ºæœ¬åœ°è·¯å¾„

**æ–‡ä»¶**:
- `frontend/src/components/FilePreview/PreviewDialog.vue`
- `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**å…³é”®ä»£ç **:
```javascript
// ä» CDN æ”¹ä¸ºæœ¬åœ°
pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
```

---

### é—®é¢˜ 2: PC ç«¯ PDF é¢„è§ˆ

**ç—‡çŠ¶**: PDF é¢„è§ˆæ— æ³•æ­£å¸¸å·¥ä½œ

**ä¿®å¤**: é€šè¿‡ä¿®å¤ worker åŠ è½½é—®é¢˜è§£å†³

**éªŒè¯**: å‰ç«¯å’Œåç«¯éƒ½å·²å¯åŠ¨

---

### é—®é¢˜ 3: æ–‡ä»¶é™åˆ¶æœªç”Ÿæ•ˆ

#### åç«¯éªŒè¯

**æ–‡ä»¶**: `backend/apps/documents/views.py`

**ä¿®æ”¹**:
- `upload_document()` å‡½æ•°æ·»åŠ éªŒè¯
- `batch_upload()` å‡½æ•°æ·»åŠ éªŒè¯

**éªŒè¯å†…å®¹**:
```python
# 1. æ–‡ä»¶ç±»å‹éªŒè¯
if doc_type.allowed_file_types and len(doc_type.allowed_file_types) > 0:
    if file_type not in doc_type.allowed_file_types:
        return Response({'error': 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'}, status=400)

# 2. æ–‡ä»¶æ•°é‡éªŒè¯
if doc_type.max_file_count > 0:
    existing_count = Document.objects.filter(
        customer=customer,
        document_type=doc_type
    ).count()
    if existing_count >= doc_type.max_file_count:
        return Response({'error': 'å·²è¾¾åˆ°æœ€å¤§æ–‡ä»¶æ•°é™åˆ¶'}, status=400)
```

#### PC ç«¯éªŒè¯

**æ–‡ä»¶**: `frontend/src/views/pc/CustomerDetail.vue`

**æ–°å¢è®¡ç®—å±æ€§**:
- `currentDocumentType` - å½“å‰èµ„æ–™ç±»å‹
- `uploadedCount` - å·²ä¸Šä¼ æ–‡ä»¶æ•°
- `canUpload` - æ˜¯å¦å¯ä¸Šä¼ 
- `uploadHintText` - æç¤ºæ–‡æœ¬
- `acceptAttribute` - åŠ¨æ€ accept å±æ€§

**æ–°å¢éªŒè¯**:
```javascript
// æ£€æŸ¥æ–‡ä»¶æ•°é‡
if (!canUpload.value) {
  ElMessage.error('å·²è¾¾åˆ°æœ€å¤§æ–‡ä»¶æ•°é™åˆ¶')
  return
}

// æ£€æŸ¥æ–‡ä»¶ç±»å‹
if (docType.allowed_file_types && docType.allowed_file_types.length > 0) {
  for (const file of fileList.value) {
    const fileType = getFileType(file.name)
    if (!docType.allowed_file_types.includes(fileType)) {
      ElMessage.error(`æ–‡ä»¶ç±»å‹ä¸ç¬¦åˆè¦æ±‚`)
      return
    }
  }
}
```

#### ç§»åŠ¨ç«¯éªŒè¯

**æ–‡ä»¶**: `frontend/src/views/mobile/CustomerDetail.vue`

**æ–°å¢è®¡ç®—å±æ€§**:
- `currentDocumentType` - å½“å‰èµ„æ–™ç±»å‹
- `uploadedCount` - å·²ä¸Šä¼ æ–‡ä»¶æ•°
- `canUpload` - æ˜¯å¦å¯ä¸Šä¼ 

**æ–°å¢éªŒè¯**:
```javascript
// æ£€æŸ¥æ–‡ä»¶æ•°é‡
if (!canUpload.value) {
  showToast('å·²è¾¾åˆ°æœ€å¤§æ–‡ä»¶æ•°é™åˆ¶')
  return
}
```

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| ä¿®æ”¹æ–‡ä»¶ | 5 ä¸ª |
| æ–°å¢ä»£ç è¡Œæ•° | ~200 è¡Œ |
| å¤åˆ¶èµ„æºæ–‡ä»¶ | 1 ä¸ª |

---

## âœ… éªŒè¯æ¸…å•

- [x] PDF worker æ–‡ä»¶å·²å¤åˆ¶
- [x] Worker é…ç½®å·²æ›´æ–°
- [x] åç«¯éªŒè¯å·²å®ç°
- [x] PC ç«¯éªŒè¯å·²å®ç°
- [x] ç§»åŠ¨ç«¯éªŒè¯å·²å®ç°
- [x] é”™è¯¯æç¤ºå·²å®Œå–„

---

## ğŸš€ å¯åŠ¨æœåŠ¡

```bash
# åç«¯
cd backend
python manage.py runserver

# å‰ç«¯
cd frontend
npm run dev
```

**è®¿é—®åœ°å€**:
- å‰ç«¯: http://127.0.0.1:3001
- åç«¯: http://127.0.0.1:8000

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• PDF é¢„è§ˆ

1. ä¸Šä¼  PDF æ–‡ä»¶
2. åœ¨ PC ç«¯é¢„è§ˆ - åº”è¯¥æ­£å¸¸æ˜¾ç¤º
3. åœ¨ç§»åŠ¨ç«¯é¢„è§ˆ - åº”è¯¥æ­£å¸¸æ˜¾ç¤º
4. æµ‹è¯•é¡µç å¯¼èˆª

### æµ‹è¯•æ–‡ä»¶é™åˆ¶

1. åœ¨ç®¡ç†åå°è®¾ç½®èµ„æ–™ç±»å‹çš„é™åˆ¶
2. å°è¯•ä¸Šä¼ è¶…è¿‡é™åˆ¶çš„æ–‡ä»¶ç±»å‹ - åº”è¯¥è¢«æ‹’ç»
3. å°è¯•ä¸Šä¼ è¶…è¿‡é™åˆ¶çš„æ–‡ä»¶æ•°é‡ - åº”è¯¥è¢«æ‹’ç»
4. éªŒè¯é”™è¯¯æç¤ºä¿¡æ¯

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. `frontend/src/components/FilePreview/PreviewDialog.vue`
2. `frontend/src/components/FilePreview/MobilePreviewDialog.vue`
3. `backend/apps/documents/views.py`
4. `frontend/src/views/pc/CustomerDetail.vue`
5. `frontend/src/views/mobile/CustomerDetail.vue`

### æ–°å»ºçš„æ–‡ä»¶

- `frontend/public/pdf.worker.min.mjs` (å¤åˆ¶)

---

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **PDF.js Worker**: å¿…é¡»ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œä¸èƒ½ä¾èµ– CDN
2. **åç«¯éªŒè¯**: å¼ºåˆ¶éªŒè¯ç¡®ä¿æ•°æ®å®‰å…¨
3. **å‰ç«¯éªŒè¯**: æå‡ç”¨æˆ·ä½“éªŒï¼Œæå‰åé¦ˆ
4. **é”™è¯¯å¤„ç†**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯æŒ‡å¯¼ç”¨æˆ·

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

âœ… PDF é¢„è§ˆæ­£å¸¸å·¥ä½œ  
âœ… æ–‡ä»¶ç±»å‹é™åˆ¶ç”Ÿæ•ˆ  
âœ… æ–‡ä»¶æ•°é‡é™åˆ¶ç”Ÿæ•ˆ  
âœ… ç”¨æˆ·ä½“éªŒæ”¹è¿›  
âœ… ç³»ç»Ÿå®‰å…¨æ€§æå‡

---

**å¿«é€Ÿå‚è€ƒå®Œæˆ** âœ…

