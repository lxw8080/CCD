# 快速参考 - 三个关键问题修复

**日期**: 2025-10-18  
**版本**: 1.0

---

## 🔧 修复内容速览

### 问题 1: PDF.js Worker 加载错误

**症状**: 移动端 PDF 预览报错 404

**修复**:
1. 创建 `frontend/public` 目录
2. 复制 `pdf.worker.min.mjs` 到 public 目录
3. 更新 worker 配置为本地路径

**文件**:
- `frontend/src/components/FilePreview/PreviewDialog.vue`
- `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**关键代码**:
```javascript
// 从 CDN 改为本地
pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
```

---

### 问题 2: PC 端 PDF 预览

**症状**: PDF 预览无法正常工作

**修复**: 通过修复 worker 加载问题解决

**验证**: 前端和后端都已启动

---

### 问题 3: 文件限制未生效

#### 后端验证

**文件**: `backend/apps/documents/views.py`

**修改**:
- `upload_document()` 函数添加验证
- `batch_upload()` 函数添加验证

**验证内容**:
```python
# 1. 文件类型验证
if doc_type.allowed_file_types and len(doc_type.allowed_file_types) > 0:
    if file_type not in doc_type.allowed_file_types:
        return Response({'error': '不支持的文件类型'}, status=400)

# 2. 文件数量验证
if doc_type.max_file_count > 0:
    existing_count = Document.objects.filter(
        customer=customer,
        document_type=doc_type
    ).count()
    if existing_count >= doc_type.max_file_count:
        return Response({'error': '已达到最大文件数限制'}, status=400)
```

#### PC 端验证

**文件**: `frontend/src/views/pc/CustomerDetail.vue`

**新增计算属性**:
- `currentDocumentType` - 当前资料类型
- `uploadedCount` - 已上传文件数
- `canUpload` - 是否可上传
- `uploadHintText` - 提示文本
- `acceptAttribute` - 动态 accept 属性

**新增验证**:
```javascript
// 检查文件数量
if (!canUpload.value) {
  ElMessage.error('已达到最大文件数限制')
  return
}

// 检查文件类型
if (docType.allowed_file_types && docType.allowed_file_types.length > 0) {
  for (const file of fileList.value) {
    const fileType = getFileType(file.name)
    if (!docType.allowed_file_types.includes(fileType)) {
      ElMessage.error(`文件类型不符合要求`)
      return
    }
  }
}
```

#### 移动端验证

**文件**: `frontend/src/views/mobile/CustomerDetail.vue`

**新增计算属性**:
- `currentDocumentType` - 当前资料类型
- `uploadedCount` - 已上传文件数
- `canUpload` - 是否可上传

**新增验证**:
```javascript
// 检查文件数量
if (!canUpload.value) {
  showToast('已达到最大文件数限制')
  return
}
```

---

## 📊 修改统计

| 项目 | 数量 |
|------|------|
| 修改文件 | 5 个 |
| 新增代码行数 | ~200 行 |
| 复制资源文件 | 1 个 |

---

## ✅ 验证清单

- [x] PDF worker 文件已复制
- [x] Worker 配置已更新
- [x] 后端验证已实现
- [x] PC 端验证已实现
- [x] 移动端验证已实现
- [x] 错误提示已完善

---

## 🚀 启动服务

```bash
# 后端
cd backend
python manage.py runserver

# 前端
cd frontend
npm run dev
```

**访问地址**:
- 前端: http://127.0.0.1:3001
- 后端: http://127.0.0.1:8000

---

## 🧪 测试步骤

### 测试 PDF 预览

1. 上传 PDF 文件
2. 在 PC 端预览 - 应该正常显示
3. 在移动端预览 - 应该正常显示
4. 测试页码导航

### 测试文件限制

1. 在管理后台设置资料类型的限制
2. 尝试上传超过限制的文件类型 - 应该被拒绝
3. 尝试上传超过限制的文件数量 - 应该被拒绝
4. 验证错误提示信息

---

## 📝 文件清单

### 修改的文件

1. `frontend/src/components/FilePreview/PreviewDialog.vue`
2. `frontend/src/components/FilePreview/MobilePreviewDialog.vue`
3. `backend/apps/documents/views.py`
4. `frontend/src/views/pc/CustomerDetail.vue`
5. `frontend/src/views/mobile/CustomerDetail.vue`

### 新建的文件

- `frontend/public/pdf.worker.min.mjs` (复制)

---

## 💡 关键要点

1. **PDF.js Worker**: 必须使用本地文件，不能依赖 CDN
2. **后端验证**: 强制验证确保数据安全
3. **前端验证**: 提升用户体验，提前反馈
4. **错误处理**: 清晰的错误信息指导用户

---

## 🎯 预期效果

✅ PDF 预览正常工作  
✅ 文件类型限制生效  
✅ 文件数量限制生效  
✅ 用户体验改进  
✅ 系统安全性提升

---

**快速参考完成** ✅

