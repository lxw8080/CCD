# 图片上传问题修复说明

## 修复的问题

### 1. ❌ 后端上传错误
**错误信息：**
```
AttributeError: 'NoneType' object has no attribute 'strftime'
```

**原因：** `document_upload_path` 函数尝试访问 `instance.uploaded_at`，但该字段在文件保存时还未设置。

**修复：** 使用 `timezone.now()` 代替 `instance.uploaded_at`

### 2. ❌ 移动端资料类型选择器不显示

**原因：** 
- 后端 API 启用了分页，返回格式为 `{results: [...], count: N}`
- 前端数据处理不完善

**修复：**
- 后端：禁用 `DocumentTypeViewSet` 的分页
- 前端：更新数据处理逻辑

## 修改的文件

1. ✅ `backend/apps/documents/models.py` - 修复文件上传路径生成
2. ✅ `backend/apps/documents/views.py` - 禁用资料类型分页
3. ✅ `frontend/src/views/mobile/CustomerDetail.vue` - 更新数据处理
4. ✅ `frontend/src/views/pc/CustomerDetail.vue` - 更新数据处理

## 使用方法

### 1. 重启服务

**后端：**
```bash
# 如果后端正在运行，请先停止（Ctrl+C）
cd backend
python manage.py runserver
```

**前端：**
```bash
# 如果前端正在运行，请先停止（Ctrl+C）
cd frontend
npm run dev
```

### 2. 测试上传功能

1. 登录系统
2. 进入任意客户详情页
3. 点击"资料类型"选择框
   - ✅ 移动端：应该弹出选择器
   - ✅ PC端：应该显示下拉选项
4. 选择一个资料类型
5. 点击上传按钮选择图片
6. 点击"上传"按钮
7. ✅ 应该成功上传，不再出现 500 错误

### 3. 验证结果

- 上传成功后，页面会显示上传的资料
- 图片保存在 `backend/media/documents/{customer_id}/` 目录
- 文件名格式：`{customer_id}_{document_type_id}_{timestamp}.jpg`

## 技术细节

### 后端修改

**文件：** `backend/apps/documents/models.py`
```python
def document_upload_path(instance, filename):
    """生成文件上传路径"""
    ext = os.path.splitext(filename)[1]
    # 使用当前时间，因为 uploaded_at 在文件保存时还未设置
    timestamp = timezone.now().strftime('%Y%m%d%H%M%S')
    new_filename = f"{instance.customer.id}_{instance.document_type.id}_{timestamp}{ext}"
    return os.path.join('documents', str(instance.customer.id), new_filename)
```

**文件：** `backend/apps/documents/views.py`
```python
class DocumentTypeViewSet(viewsets.ModelViewSet):
    """资料类型视图集"""
    queryset = DocumentType.objects.all()
    serializer_class = DocumentTypeSerializer
    permission_classes = [IsAuthenticated]
    pagination_class = None  # 禁用分页，返回所有资料类型
```

### 前端修改

**文件：** `frontend/src/views/mobile/CustomerDetail.vue` 和 `frontend/src/views/pc/CustomerDetail.vue`
```javascript
const fetchDocumentTypes = async () => {
  try {
    const response = await getDocumentTypes()
    // API 返回的是数组（已禁用分页）
    documentTypes.value = Array.isArray(response) ? response : []
  } catch (error) {
    console.error('获取资料类型失败:', error)
    showToast('获取资料类型失败')
  }
}
```

## 注意事项

1. ✅ 后端测试已通过，路径生成功能正常
2. ✅ 资料类型数据已存在（9个类型）
3. ✅ 客户数据已存在（5个客户）
4. 如遇到缓存问题，请刷新浏览器（Ctrl+Shift+R）
5. 确保 `backend/media/documents/` 目录有写入权限

## 测试结果

```
资料类型: [通过]
客户数据: [通过]
上传路径: [通过]

[成功] 所有测试通过！可以尝试上传图片了。
```

---

**修复完成时间：** 2025-10-14
**修复状态：** ✅ 已完成并测试通过

