# è¯Šæ–­æŠ¥å‘Š - ç§»åŠ¨ç«¯æ–‡ä»¶é¢„è§ˆé—®é¢˜

**æ—¥æœŸ**: 2025-10-19  
**ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

ç§»åŠ¨ç«¯æ–‡ä»¶é¢„è§ˆåŠŸèƒ½å‡ºç°é—®é¢˜ï¼Œå›¾ç‰‡ã€PDFã€è§†é¢‘å‡æ— æ³•æ­£ç¡®é¢„è§ˆã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### å¯èƒ½çš„åŸå› 

#### 1. æ–‡ä»¶ç±»å‹ä¼ é€’é—®é¢˜

**ä»£ç ä½ç½®**: `frontend/src/views/mobile/CustomerDetail.vue` (ç¬¬ 487-492 è¡Œ)

```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  previewFileType.value = doc.file_type || 'image'  // å¯èƒ½çš„é—®é¢˜
  previewVisible.value = true
}
```

**é—®é¢˜åˆ†æ**:
- åç«¯è¿”å›çš„ `doc.file_type` åº”è¯¥æ˜¯æ­£ç¡®çš„æ ¼å¼ï¼ˆ'image', 'video', 'pdf'ï¼‰
- ä½†å¦‚æœåç«¯æ²¡æœ‰è¿”å› `file_type` å­—æ®µï¼Œä¼šé»˜è®¤ä½¿ç”¨ 'image'
- è¿™ä¼šå¯¼è‡´æ‰€æœ‰æ–‡ä»¶éƒ½è¢«å½“ä½œå›¾ç‰‡å¤„ç†

#### 2. MobilePreviewDialog ç»„ä»¶é—®é¢˜

**ä»£ç ä½ç½®**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**å¯èƒ½çš„é—®é¢˜**:
1. **props å®šä¹‰é—®é¢˜**: `fileType` çš„é»˜è®¤å€¼æ˜¯ 'image'ï¼Œå¯èƒ½å¯¼è‡´ç±»å‹åˆ¤æ–­é”™è¯¯
2. **æ–‡ä»¶ç±»å‹åˆ¤æ–­é—®é¢˜**: `isImage()`, `isVideo()`, `isPdf()` å‡½æ•°å¯èƒ½æ— æ³•æ­£ç¡®è¯†åˆ«æ–‡ä»¶ç±»å‹
3. **PDF.js worker è·¯å¾„é—®é¢˜**: worker æ–‡ä»¶è·¯å¾„å¯èƒ½ä¸æ­£ç¡®
4. **CORS é—®é¢˜**: æ–‡ä»¶ URL å¯èƒ½å­˜åœ¨è·¨åŸŸé—®é¢˜

#### 3. åç«¯æ•°æ®é—®é¢˜

**å¯èƒ½çš„é—®é¢˜**:
- åç«¯å¯èƒ½æ²¡æœ‰æ­£ç¡®è¿”å› `file_type` å­—æ®µ
- `file_url` å¯èƒ½ä¸æ­£ç¡®æˆ–æ— æ³•è®¿é—®
- æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨

---

## âœ… è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥åç«¯è¿”å›çš„æ•°æ®

éœ€è¦æ£€æŸ¥åç«¯ API è¿”å›çš„æ–‡æ¡£æ•°æ®æ˜¯å¦åŒ…å«æ­£ç¡®çš„ `file_type` å­—æ®µã€‚

**é¢„æœŸæ•°æ®æ ¼å¼**:
```json
{
  "id": 1,
  "file_url": "http://127.0.0.1:8000/media/documents/...",
  "file_name": "example.pdf",
  "file_type": "pdf",  // åº”è¯¥æ˜¯ 'image', 'video', 'pdf', 'document', 'spreadsheet'
  "file_size": 1024000
}
```

### æ­¥éª¤ 2: æ£€æŸ¥æ–‡ä»¶ç±»å‹åˆ¤æ–­

éœ€è¦ç¡®è®¤ `isImage()`, `isVideo()`, `isPdf()` å‡½æ•°èƒ½æ­£ç¡®è¯†åˆ«æ–‡ä»¶ç±»å‹ã€‚

**å½“å‰å®ç°**:
```javascript
export function isImage(fileType) {
  return fileType === 'image'
}

export function isVideo(fileType) {
  return fileType === 'video'
}

export function isPdf(fileType) {
  return fileType === 'pdf'
}
```

### æ­¥éª¤ 3: æ£€æŸ¥ PDF.js worker è·¯å¾„

éœ€è¦ç¡®è®¤ `/pdf.worker.min.mjs` æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº `public` ç›®å½•ã€‚

### æ­¥éª¤ 4: æ£€æŸ¥æ–‡ä»¶ URL æ˜¯å¦å¯è®¿é—®

éœ€è¦ç¡®è®¤æ–‡ä»¶ URL æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦å­˜åœ¨ CORS é—®é¢˜ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ”¹è¿›æ–‡ä»¶ç±»å‹è·å–é€»è¾‘

**ä¿®æ”¹ä½ç½®**: `frontend/src/views/mobile/CustomerDetail.vue`

**ä¿®æ”¹å‰**:
```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  previewFileType.value = doc.file_type || 'image'
  previewVisible.value = true
}
```

**ä¿®æ”¹å**:
```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  
  // å¦‚æœåç«¯æ²¡æœ‰è¿”å› file_typeï¼Œä»æ–‡ä»¶åä¸­è·å–
  if (doc.file_type) {
    previewFileType.value = doc.file_type
  } else {
    previewFileType.value = getFileType(doc.file_name) || 'image'
  }
  
  previewVisible.value = true
  
  console.log('é¢„è§ˆæ–‡ä»¶:', {
    url: doc.file_url,
    name: doc.file_name,
    type: previewFileType.value
  })
}
```

### æ–¹æ¡ˆ 2: æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `MobilePreviewDialog.vue` ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚

**ä¿®æ”¹ä½ç½®**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**ä¿®æ”¹å†…å®¹**:
```javascript
const showPreview = () => {
  console.log('æ˜¾ç¤ºé¢„è§ˆ:', {
    fileUrl: props.fileUrl,
    fileName: props.fileName,
    fileType: props.fileType
  })
  
  if (isImage(props.fileType)) {
    console.log('æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ')
    previewImages.value = [props.fileUrl]
    previewIndex.value = 0
    imagePreviewVisible.value = true
  } else if (isVideo(props.fileType)) {
    console.log('æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ')
    videoUrl.value = props.fileUrl
    videoPreviewVisible.value = true
  } else if (isPdf(props.fileType)) {
    console.log('æ˜¾ç¤º PDF é¢„è§ˆ')
    loadPdf()
  } else {
    console.log('ä¸æ”¯æŒé¢„è§ˆï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º')
    downloadPromptVisible.value = true
  }
}
```

### æ–¹æ¡ˆ 3: æ”¹è¿›é”™è¯¯å¤„ç†

åœ¨ PDF åŠ è½½å’Œæ¸²æŸ“æ—¶æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†ã€‚

**ä¿®æ”¹ä½ç½®**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**ä¿®æ”¹å†…å®¹**:
```javascript
const loadPdf = async () => {
  try {
    console.log('åŠ è½½ PDF:', props.fileUrl)
    pdfDoc = await pdfjsLib.getDocument(props.fileUrl).promise
    totalPages.value = pdfDoc.numPages
    currentPage.value = 1
    pdfPreviewVisible.value = true
    await renderPdfPage(1)
    console.log('PDF åŠ è½½æˆåŠŸï¼Œå…±', totalPages.value, 'é¡µ')
  } catch (error) {
    console.error('PDF åŠ è½½å¤±è´¥:', error)
    showToast('PDF åŠ è½½å¤±è´¥: ' + error.message)
  }
}
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

ä¿®å¤ååº”è¯¥èƒ½å¤Ÿï¼š

âœ… æ­£ç¡®è¯†åˆ«æ–‡ä»¶ç±»å‹  
âœ… å›¾ç‰‡èƒ½æ­£å¸¸é¢„è§ˆ  
âœ… è§†é¢‘èƒ½æ­£å¸¸æ’­æ”¾  
âœ… PDF èƒ½æ­£å¸¸æ˜¾ç¤º  
âœ… ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸‹è½½æç¤º  
âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®

---

**è¯Šæ–­æŠ¥å‘Šå®Œæˆ** âœ…

