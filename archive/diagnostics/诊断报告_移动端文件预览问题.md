# 诊断报告 - 移动端文件预览问题

**日期**: 2025-10-19  
**版本**: 1.0

---

## 📋 问题概述

移动端文件预览功能出现问题，图片、PDF、视频均无法正确预览。

---

## 🔍 问题分析

### 可能的原因

#### 1. 文件类型传递问题

**代码位置**: `frontend/src/views/mobile/CustomerDetail.vue` (第 487-492 行)

```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  previewFileType.value = doc.file_type || 'image'  // 可能的问题
  previewVisible.value = true
}
```

**问题分析**:
- 后端返回的 `doc.file_type` 应该是正确的格式（'image', 'video', 'pdf'）
- 但如果后端没有返回 `file_type` 字段，会默认使用 'image'
- 这会导致所有文件都被当作图片处理

#### 2. MobilePreviewDialog 组件问题

**代码位置**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**可能的问题**:
1. **props 定义问题**: `fileType` 的默认值是 'image'，可能导致类型判断错误
2. **文件类型判断问题**: `isImage()`, `isVideo()`, `isPdf()` 函数可能无法正确识别文件类型
3. **PDF.js worker 路径问题**: worker 文件路径可能不正确
4. **CORS 问题**: 文件 URL 可能存在跨域问题

#### 3. 后端数据问题

**可能的问题**:
- 后端可能没有正确返回 `file_type` 字段
- `file_url` 可能不正确或无法访问
- 文件可能不存在

---

## ✅ 诊断步骤

### 步骤 1: 检查后端返回的数据

需要检查后端 API 返回的文档数据是否包含正确的 `file_type` 字段。

**预期数据格式**:
```json
{
  "id": 1,
  "file_url": "http://127.0.0.1:8000/media/documents/...",
  "file_name": "example.pdf",
  "file_type": "pdf",  // 应该是 'image', 'video', 'pdf', 'document', 'spreadsheet'
  "file_size": 1024000
}
```

### 步骤 2: 检查文件类型判断

需要确认 `isImage()`, `isVideo()`, `isPdf()` 函数能正确识别文件类型。

**当前实现**:
```javascript
export function isImage(fileType) {
  return fileType === 'image'
}

export function isVideo(fileType) {
  return fileType === 'video'
}

export function isPdf(fileType) {
  return fileType === 'pdf'
}
```

### 步骤 3: 检查 PDF.js worker 路径

需要确认 `/pdf.worker.min.mjs` 文件是否存在于 `public` 目录。

### 步骤 4: 检查文件 URL 是否可访问

需要确认文件 URL 是否正确，是否存在 CORS 问题。

---

## 🔧 修复方案

### 方案 1: 改进文件类型获取逻辑

**修改位置**: `frontend/src/views/mobile/CustomerDetail.vue`

**修改前**:
```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  previewFileType.value = doc.file_type || 'image'
  previewVisible.value = true
}
```

**修改后**:
```javascript
const handlePreview = (doc) => {
  previewUrl.value = doc.file_url
  previewFileName.value = doc.file_name
  
  // 如果后端没有返回 file_type，从文件名中获取
  if (doc.file_type) {
    previewFileType.value = doc.file_type
  } else {
    previewFileType.value = getFileType(doc.file_name) || 'image'
  }
  
  previewVisible.value = true
  
  console.log('预览文件:', {
    url: doc.file_url,
    name: doc.file_name,
    type: previewFileType.value
  })
}
```

### 方案 2: 添加调试日志

在 `MobilePreviewDialog.vue` 中添加调试日志，帮助诊断问题。

**修改位置**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**修改内容**:
```javascript
const showPreview = () => {
  console.log('显示预览:', {
    fileUrl: props.fileUrl,
    fileName: props.fileName,
    fileType: props.fileType
  })
  
  if (isImage(props.fileType)) {
    console.log('显示图片预览')
    previewImages.value = [props.fileUrl]
    previewIndex.value = 0
    imagePreviewVisible.value = true
  } else if (isVideo(props.fileType)) {
    console.log('显示视频预览')
    videoUrl.value = props.fileUrl
    videoPreviewVisible.value = true
  } else if (isPdf(props.fileType)) {
    console.log('显示 PDF 预览')
    loadPdf()
  } else {
    console.log('不支持预览，显示下载提示')
    downloadPromptVisible.value = true
  }
}
```

### 方案 3: 改进错误处理

在 PDF 加载和渲染时添加更详细的错误处理。

**修改位置**: `frontend/src/components/FilePreview/MobilePreviewDialog.vue`

**修改内容**:
```javascript
const loadPdf = async () => {
  try {
    console.log('加载 PDF:', props.fileUrl)
    pdfDoc = await pdfjsLib.getDocument(props.fileUrl).promise
    totalPages.value = pdfDoc.numPages
    currentPage.value = 1
    pdfPreviewVisible.value = true
    await renderPdfPage(1)
    console.log('PDF 加载成功，共', totalPages.value, '页')
  } catch (error) {
    console.error('PDF 加载失败:', error)
    showToast('PDF 加载失败: ' + error.message)
  }
}
```

---

## 📊 预期效果

修复后应该能够：

✅ 正确识别文件类型  
✅ 图片能正常预览  
✅ 视频能正常播放  
✅ PDF 能正常显示  
✅ 不支持的文件类型显示下载提示  
✅ 错误信息清晰明确

---

**诊断报告完成** ✅

