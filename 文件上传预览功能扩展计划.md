# 文件上传和预览功能扩展计划

**制定日期**: 2025-10-18  
**目标**: 扩展系统支持多种文件类型的上传和预览

---

## 📋 需求概述

### 需求 1: 扩展文件上传格式支持

**当前状态**: 仅支持图片上传 (ImageField)

**目标状态**: 支持以下文件类型：
- 图片: .jpg, .jpeg, .png, .gif, .bmp, .webp
- 视频: .mp4, .avi, .mov, .wmv, .flv, .mkv
- PDF: .pdf
- 文档: .doc, .docx, .txt, .rtf
- 表格: .xls, .xlsx, .csv

**文件大小限制**:
- 图片: 5MB
- 视频: 50MB
- 文档: 10MB
- 表格: 10MB
- PDF: 10MB

### 需求 2: 增加文件预览功能

**支持的预览类型**:
1. 图片预览 - 保持现有功能
2. 视频预览 - HTML5 video 标签
3. PDF预览 - iframe 或 PDF.js
4. 其他文件 - 提供下载功能

---

## 🔧 实施计划

### 第一阶段: 后端修改

#### 1.1 修改 Document 模型
**文件**: `backend/apps/documents/models.py`

**修改内容**:
```python
# 添加文件类型常量
FILE_TYPES = {
    'image': ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'],
    'video': ['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv'],
    'pdf': ['pdf'],
    'document': ['doc', 'docx', 'txt', 'rtf'],
    'spreadsheet': ['xls', 'xlsx', 'csv']
}

# 修改 file 字段
file = models.FileField(upload_to=document_upload_path, verbose_name='文件')

# 添加 file_type 字段
file_type = models.CharField(
    max_length=20,
    choices=[('image', '图片'), ('video', '视频'), ('pdf', 'PDF'), 
             ('document', '文档'), ('spreadsheet', '表格')],
    default='image',
    verbose_name='文件类型'
)
```

#### 1.2 创建文件验证器
**文件**: `backend/apps/documents/validators.py` (新建)

**功能**:
- 验证文件扩展名
- 验证文件大小
- 获取文件类型

#### 1.3 更新序列化器
**文件**: `backend/apps/documents/serializers.py`

**修改**:
- 更新 DocumentUploadSerializer 支持多种文件类型
- 添加文件类型验证
- 添加 file_type 字段到 DocumentSerializer

#### 1.4 更新视图
**文件**: `backend/apps/documents/views.py`

**修改**:
- 更新 upload_document 视图支持多种文件类型
- 更新 batch_upload 视图

---

### 第二阶段: 前端修改

#### 2.1 创建文件类型判断工具
**文件**: `frontend/src/utils/fileType.js` (新建)

**功能**:
```javascript
// 根据文件扩展名判断文件类型
export function getFileType(filename) {
  // 返回: 'image', 'video', 'pdf', 'document', 'spreadsheet'
}

// 获取文件类型的中文名称
export function getFileTypeName(fileType) {
  // 返回中文名称
}

// 获取文件类型的图标
export function getFileTypeIcon(fileType) {
  // 返回图标类名
}
```

#### 2.2 创建预览组件库
**文件**: `frontend/src/components/FilePreview/` (新建目录)

**组件**:
- `ImagePreview.vue` - 图片预览
- `VideoPreview.vue` - 视频预览
- `PdfPreview.vue` - PDF预览
- `FileDownload.vue` - 文件下载
- `PreviewDialog.vue` - 预览对话框

#### 2.3 更新上传组件
**文件**: `frontend/src/views/pc/CustomerDetail.vue`

**修改**:
- 更新 accept 属性支持多种文件类型
- 添加文件类型选择器
- 更新上传逻辑处理不同文件类型
- 移除图片压缩（仅对图片）

#### 2.4 更新已上传资料列表
**文件**: `frontend/src/views/pc/CustomerDetail.vue`

**修改**:
- 添加文件类型图标
- 更新预览逻辑支持多种文件类型
- 添加下载功能

#### 2.5 更新移动端组件
**文件**: `frontend/src/views/mobile/CustomerDetail.vue`

**修改**:
- 同步 PC 端的所有修改

---

## 📊 修改统计

| 项目 | 数量 |
|------|------|
| 后端文件修改 | 4 个 |
| 后端新建文件 | 1 个 |
| 前端文件修改 | 3 个 |
| 前端新建文件 | 6 个 |
| 总计 | 14 个 |

---

## ✅ 验证计划

### 测试场景

1. **上传测试**:
   - 上传各种文件类型
   - 验证文件大小限制
   - 验证文件类型验证

2. **预览测试**:
   - 预览图片
   - 预览视频
   - 预览 PDF
   - 下载其他文件类型

3. **兼容性测试**:
   - PC 端功能
   - 移动端功能
   - 不同浏览器

---

## 🎯 实施顺序

1. ✅ 制定计划 (当前)
2. ⏳ 后端模型修改
3. ⏳ 后端验证器创建
4. ⏳ 后端序列化器更新
5. ⏳ 前端工具函数创建
6. ⏳ 前端预览组件创建
7. ⏳ 前端上传组件更新
8. ⏳ 前端列表组件更新
9. ⏳ 测试所有功能
10. ⏳ 生成验证报告

---

## 📝 注意事项

1. 确保修改后不影响现有的图片上传功能
2. 需要创建数据库迁移
3. 需要更新文件存储路径
4. 需要考虑文件安全性
5. 需要添加适当的错误处理

---

**预计完成时间**: 2-3 小时  
**优先级**: 高

